<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Calendari iCal Airbnb</title>
    <!-- Caricamento di Tailwind CSS per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Utilizzo del font Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .calendar-day {
            min-height: 80px;
            border: 1px solid #e5e7eb;
        }
        .reservation {
            font-size: 10px;
            padding: 2px 4px;
            margin-bottom: 2px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="bg-white shadow-lg rounded-xl p-4 mb-6">
            <h1 class="text-3xl font-bold text-indigo-700">üóìÔ∏è Calendario Unificato Affitti Brevi</h1>
            <p id="user-info" class="text-sm text-gray-500 mt-1">Caricamento...</p>
        </header>

        <!-- Sezione Inserimento URL iCal -->
        <section class="bg-white shadow-lg rounded-xl p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Aggiungi Calendario iCal</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="ical-name" placeholder="Nome Appartamento (es. Monolocale Centro)"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <input type="url" id="ical-url" placeholder="URL iCal (inizia con webcal:// o https://)"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <button onclick="saveIcalUrl()"
                        class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md whitespace-nowrap">
                    Salva URL
                </button>
            </div>
            <p class="text-xs text-red-600" id="error-message" style="display: none;"></p>
        </section>

        <!-- Sezione URL Salvati e Sincronizzazione -->
        <section class="bg-white shadow-lg rounded-xl p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">I Miei Calendari Salvati (<span id="url-count">0</span>)</h2>
            <div id="ical-list" class="space-y-3">
                <!-- URL iCal salvati saranno iniettati qui -->
                <p class="text-sm text-gray-500" id="loading-urls">Caricamento URL salvati...</p>
            </div>
            <button onclick="loadCalendar()" id="sync-button"
                    class="mt-6 w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition duration-150 shadow-lg">
                Sincronizza e Visualizza Calendario
            </button>
        </section>

        <!-- Sezione Visualizzazione Calendario -->
        <section class="bg-white shadow-lg rounded-xl p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Visualizzazione Prenotazioni</h2>

            <!-- Navigazione Mese -->
            <div class="flex justify-between items-center mb-4">
                <button onclick="changeMonth(-1)" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <span id="current-month" class="text-2xl font-bold text-gray-800"></span>
                <button onclick="changeMonth(1)" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>

            <!-- Griglia Calendario -->
            <div class="grid grid-cols-7 text-center font-medium text-sm text-gray-600 mb-2">
                <div>Dom</div><div>Lun</div><div>Mar</div><div>Mer</div><div>Gio</div><div>Ven</div><div>Sab</div>
            </div>
            <div id="calendar-grid" class="grid grid-cols-7">
                <!-- Le celle del calendario saranno generate qui -->
                <p class="col-span-7 text-center py-8 text-gray-500" id="calendar-placeholder">Premi "Sincronizza" per caricare le prenotazioni.</p>
            </div>
        </section>

         <!-- Modal di Avviso (Personalizzato) -->
        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full">
                <h3 class="text-lg font-bold text-red-600 mb-3" id="modal-title"></h3>
                <p class="text-sm text-gray-700 mb-4" id="modal-content"></p>
                <button onclick="closeModal()" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports e Logica -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Importa setLogLevel solo se ne hai bisogno, ma √® stato rimosso per il codice di produzione.

        // Variabili Globali
        let app;
        let db;
        let auth;
        let userId = null;
        let icalUrls = [];
        let allReservations = [];
        let currentYear = new Date().getFullYear();
        let currentMonth = new Date().getMonth();

        // Constants and Firebase setup
        const ICAL_COLLECTION = "ical_urls";
	const ICAL_PROXY_URL = "https://ical-proxy.glitch.me/";
        
        // RECUPERO VARIABILI DI AMBIENTE E CONFIGURAZIONE FIREBASE
        // SOSTITUIAMO le variabili d'ambiente con la configurazione STATICA fornita dall'utente.
        const appId = 'calendario-affitti-brevi'; // Il projectId pu√≤ fungere da AppId
        const firebaseConfig = {
            apiKey: "AIzaSyA9eZ39CpSSCMF6bORHqOAD39BKqHhLCuk",
            authDomain: "calendario-affitti-brevi.firebaseapp.com",
            projectId: "calendario-affitti-brevi",
            storageBucket: "calendario-affitti-brevi.firebasestorage.app",
            messagingSenderId: "338062221076",
            appId: "1:338062221076:web:02d734c5a712a26a38ac01",
            measurementId: "G-2EJGFF5RPQ"
        };
        // Nota: Il token di autenticazione custom viene omesso perch√© lo usiamo solo se presente nell'ambiente.
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null; 
        
        const icalListEl = document.getElementById('ical-list');
        const urlCountEl = document.getElementById('url-count');
        const placeholderEl = document.getElementById('calendar-placeholder');
        const syncButton = document.getElementById('sync-button');

        // --- FUNZIONI DI UTILITY ---

        /**
         * Mostra un modal personalizzato al posto di alert()
         * @param {string} title - Titolo del modale (es. "Errore", "Successo")
         * @param {string} message - Contenuto del messaggio
         */
        window.showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
        };

        window.closeModal = () => {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        };

        /**
         * Converte iCal date (YYYYMMDD) in oggetto Date.
         * @param {string} icalDate - Data in formato YYYYMMDD.
         * @returns {Date} Oggetto Date.
         */
        const icalToDate = (icalDate) => {
            const year = icalDate.substring(0, 4);
            const month = icalDate.substring(4, 6);
            const day = icalDate.substring(6, 8);
            // Mese √® 0-based in JS
            return new Date(year, month - 1, day);
        };

        /**
         * Funzione semplificata per il parsing del contenuto iCal (a causa delle restrizioni CORS).
         * @param {string} icsContent - Contenuto testuale del file .ics
         * @returns {Array<Object>} Lista di oggetti prenotazione
         */
        const parseIcalContent = (icsContent, name) => {
            const events = [];
            // Regex per trovare gli eventi
            const eventRegex = /BEGIN:VEVENT([\s\S]*?)END:VEVENT/g;
            let match;

            while ((match = eventRegex.exec(icsContent)) !== null) {
                const eventText = match[1];

                // Regex per estrarre DTSTART, DTEND, e SUMMARY
                const startMatch = eventText.match(/DTSTART(?:[^:]*?):(\d{8})/i);
                const endMatch = eventText.match(/DTEND(?:[^:]*?):(\d{8})/i);
                const summaryMatch = eventText.match(/SUMMARY:(.*)/i);

                if (startMatch && endMatch && summaryMatch) {
                    const startDate = icalToDate(startMatch[1]);
                    const endDate = icalToDate(endMatch[1]);
                    const summary = summaryMatch[1].trim();

                    // Rimuovi un giorno dalla data di fine perch√© DTEND √® esclusivo (il giorno dopo il check-out)
                    const actualEndDate = new Date(endDate);
                    actualEndDate.setDate(actualEndDate.getDate() - 1);

                    events.push({
                        id: `${name}-${startDate.getTime()}`,
                        apartmentName: name,
                        start: startDate,
                        end: actualEndDate,
                        summary: summary,
                    });
                }
            }
            return events;
        };


        // --- FUNZIONI FIRESTORE ---

        /**
         * Ottiene il riferimento alla collezione privata per gli URL iCal.
         * @returns {string} Il percorso completo della collezione
         */
        const getIcalCollectionPath = () => {
             // Utilizza il percorso privato standard di Canvas
             return `/artifacts/${appId}/users/${userId}/${ICAL_COLLECTION}`;
        };

        /**
         * Carica gli URL iCal salvati dall'utente da Firestore.
         */
        const loadIcalUrls = () => {
            if (!db || !userId) return;

            const path = getIcalCollectionPath();
            const q = query(collection(db, path));

            // onSnapshot per l'ascolto in tempo reale dei cambiamenti
            onSnapshot(q, (snapshot) => {
                icalUrls = [];
                icalListEl.innerHTML = ''; // Pulisci la lista corrente
                snapshot.forEach((doc) => {
                    icalUrls.push({ id: doc.id, ...doc.data() });
                });

                renderIcalList();
                urlCountEl.textContent = icalUrls.length;
                document.getElementById('loading-urls').style.display = 'none';

                if (icalUrls.length > 0) {
                    placeholderEl.textContent = "URL caricati. Premi Sincronizza per visualizzare.";
                } else {
                    placeholderEl.textContent = "Nessun URL iCal salvato. Aggiungine uno sopra.";
                }
            }, (error) => {
                console.error("Errore caricamento URL iCal:", error);
                showModal("Errore Firestore", "Impossibile caricare gli URL salvati. Controlla le regole di sicurezza.");
            });
        };

        /**
         * Salva un nuovo URL iCal nel database.
         */
        window.saveIcalUrl = async () => {
            if (!db || !userId) {
                showModal("Errore di Autenticazione", "Autenticazione non completa. Riprova.");
                return;
            }

            const name = document.getElementById('ical-name').value.trim();
            let url = document.getElementById('ical-url').value.trim();
            const errorEl = document.getElementById('error-message');

            if (!name || !url) {
                errorEl.textContent = "Inserisci sia un nome che un URL valido.";
                errorEl.style.display = 'block';
                return;
            }

            // Normalizza l'URL se inizia con webcal://
            if (url.startsWith('webcal://')) {
                url = 'https://' + url.substring(9);
            }

            try {
                // Aggiungi un nuovo documento con ID generato automaticamente
                const newDocRef = doc(collection(db, getIcalCollectionPath()));
                await setDoc(newDocRef, { name: name, url: url });
                
                document.getElementById('ical-name').value = '';
                document.getElementById('ical-url').value = '';
                errorEl.style.display = 'none';
                showModal("Successo", `L'URL "${name}" √® stato salvato correttamente.`);
            } catch (e) {
                console.error("Errore salvataggio URL: ", e);
                showModal("Errore di Salvataggio", "Impossibile salvare l'URL. Controlla le regole di sicurezza.");
            }
        };

        /**
         * Rimuove un URL iCal dal database.
         * @param {string} id - ID del documento Firestore
         */
        window.deleteIcalUrl = async (id) => {
            if (!db || !userId) return;

            try {
                const docRef = doc(db, getIcalCollectionPath(), id);
                await deleteDoc(docRef);
                showModal("Eliminato", "URL rimosso con successo.");
            } catch (e) {
                console.error("Errore eliminazione URL: ", e);
                showModal("Errore", "Impossibile eliminare l'URL. Controlla le regole di sicurezza.");
            }
        };

        /**
         * Renderizza la lista degli URL salvati nell'interfaccia.
         */
        const renderIcalList = () => {
            icalListEl.innerHTML = '';
            if (icalUrls.length === 0) {
                icalListEl.innerHTML = '<p class="text-sm text-gray-500">Nessun calendario iCal salvato.</p>';
                return;
            }

            icalUrls.forEach(ical => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-3 bg-gray-100 rounded-lg border border-gray-200';
                div.innerHTML = `
                    <div class="truncate">
                        <p class="font-medium text-gray-800">${ical.name}</p>
                        <a href="${ical.url}" target="_blank" class="text-xs text-indigo-600 hover:underline truncate">${ical.url}</a>
                    </div>
                    <button onclick="deleteIcalUrl('${ical.id}')"
                            class="text-red-500 hover:text-red-700 ml-4 p-2 transition duration-150">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3"></path></svg>
                    </button>
                `;
                icalListEl.appendChild(div);
            });
        };

        // --- FUNZIONI DI CALENDARIO e LOGICA iCAL ---

        /**
         * Fetcha e consolida tutte le prenotazioni da tutti gli URL iCal.
         */
        window.loadCalendar = async () => {
            if (!userId) {
                showModal("Autenticazione Richiesta", "L'app si sta ancora connettendo a Firebase. Riprova tra un momento.");
                return;
            }

            if (icalUrls.length === 0) {
                showModal("Attenzione", "Devi prima salvare almeno un URL iCal.");
                return;
            }

            syncButton.textContent = "Sincronizzazione in corso...";
            syncButton.disabled = true;
            allReservations = [];
            let successfulFetches = 0;

            // Tentativo di fetch per ogni URL
for (const ical of icalUrls) {
                try {
                    // Costruisce l'URL completo con il proxy se necessario
                    let fetchUrl = ical.url;
                    // Controlla se l'URL √® di Airbnb (o un altro URL bloccato) e non √® gi√† proxyzzato
                    if (fetchUrl.includes('airbnb.it/calendar/ical/') && !fetchUrl.includes(ICAL_PROXY_URL)) {
                        fetchUrl = ICAL_PROXY_URL + fetchUrl;
                    }
                    
                    // fetchUrl ora utilizza il proxy se necessario
                    const response = await fetch(fetchUrl);
                    if (!response.ok) throw new Error(`Status ${response.status}`);

                    const icsContent = await response.text();
                    const reservations = parseIcalContent(icsContent, ical.name);
                    allReservations.push(...reservations);
                    successfulFetches++;

                } catch (error) {
                    console.error(`Errore nel caricamento di ${ical.name}:`, error);
                    // Avvisa l'utente se il fetch fallisce a causa di CORS
                    if (error.message.includes("CORS")) {
                         showModal("Errore CORS", `Impossibile caricare l'URL di ${ical.name} a causa di restrizioni di sicurezza (CORS). Prova ad usare un link che non √® bloccato (spesso i link originali Airbnb/Booking sono bloccati).`);
                    } else {
                         showModal("Errore Fetch", `Impossibile caricare l'URL di ${ical.name}. Dettagli: ${error.message}`);
                    }
                }
            }
            
            syncButton.textContent = "Sincronizza e Visualizza Calendario";
            syncButton.disabled = false;
            
            if(successfulFetches > 0) {
                 renderCalendar();
                 showModal("Sincronizzazione Completata", `Sincronizzate ${allReservations.length} prenotazioni da ${successfulFetches} calendari.`);
            } else {
                 renderCalendar();
                 showModal("Sincronizzazione Fallita", `Nessun calendario √® stato caricato con successo. Verifica i tuoi URL e le impostazioni CORS. Le date e le prenotazioni saranno vuote.`);
            }
        };
        
        /**
         * Cambia il mese visualizzato e aggiorna il calendario.
         * @param {number} delta - 1 per il mese successivo, -1 per il precedente.
         */
        window.changeMonth = (delta) => {
            currentMonth += delta;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            } else if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            if (allReservations.length > 0) {
                renderCalendar();
            } else {
                renderMonthTitle(); // Aggiorna solo il titolo se non ci sono dati
            }
        };
        
        const renderMonthTitle = () => {
            const date = new Date(currentYear, currentMonth);
            document.getElementById('current-month').textContent = date.toLocaleDateString('it-IT', { year: 'numeric', month: 'long' });
        }

        /**
         * Genera la griglia del calendario e inserisce le prenotazioni.
         */
        const renderCalendar = () => {
            const gridEl = document.getElementById('calendar-grid');
            gridEl.innerHTML = ''; // Pulisce la griglia precedente
            
            renderMonthTitle();

            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0);
            const totalDaysInMonth = lastDayOfMonth.getDate();

            // Calcola l'offset (giorni vuoti all'inizio)
            let startDayOfWeek = firstDayOfMonth.getDay(); // 0 (Dom) a 6 (Sab)

            // Aggiungi celle vuote all'inizio
            for (let i = 0; i < startDayOfWeek; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'calendar-day bg-gray-50';
                gridEl.appendChild(emptyCell);
            }

            // Aggiungi le celle per i giorni del mese
            for (let day = 1; day <= totalDaysInMonth; day++) {
                const date = new Date(currentYear, currentMonth, day);
                const cell = document.createElement('div');
                cell.className = 'calendar-day p-2 relative bg-white transition hover:bg-indigo-50 overflow-hidden';

                // Numero del giorno
                const dayNum = document.createElement('div');
                dayNum.className = 'text-sm font-bold mb-1';
                dayNum.textContent = day;
                
                // Se √® il giorno corrente
                if (date.toDateString() === new Date().toDateString()) {
                     dayNum.classList.add('text-indigo-600', 'p-1', 'rounded-full', 'bg-indigo-100');
                }
                
                cell.appendChild(dayNum);

                // Inserisci le prenotazioni
                allReservations.forEach(res => {
                    // Controlla se la data cade tra l'inizio (inclusivo) e la fine (inclusivo) della prenotazione
                    if (date >= res.start && date <= res.end) {
                        const resEl = document.createElement('div');
                        
                        // Genera un colore dinamico basato sul nome dell'appartamento
                        // per differenziare le prenotazioni
                        const hashCode = str => {
                            let hash = 0;
                            for (let i = 0; i < str.length; i++) {
                                hash = str.charCodeAt(i) + ((hash << 5) - hash);
                            }
                            return hash;
                        };
                        
                        // Per una migliore leggibilit√†, usiamo classi Tailwind con colori definiti
                        const colorMap = {
                            0: { bg: 'bg-indigo-200', text: 'text-indigo-800' },
                            1: { bg: 'bg-teal-200', text: 'text-teal-800' },
                            2: { bg: 'bg-pink-200', text: 'text-pink-800' },
                            3: { bg: 'bg-orange-200', text: 'text-orange-800' },
                            4: { bg: 'bg-yellow-200', text: 'text-yellow-800' },
                        };
                        const colorIndex = Math.abs(hashCode(res.apartmentName) % 5);
                        const color = colorMap[colorIndex];
                        
                        resEl.className = `reservation ${color.bg} ${color.text} font-semibold`;
                        resEl.title = `${res.summary} (${res.apartmentName})`;
                        resEl.textContent = `${res.summary.substring(0, 15)}...`; 
                        
                        cell.appendChild(resEl);
                    }
                });

                gridEl.appendChild(cell);
            }
            
            // Rimuovi il placeholder dopo il rendering
            if (gridEl.children.length > 0) {
                 placeholderEl.style.display = 'none';
            }
        };

        // --- INIZIALIZZAZIONE ---

        const initFirebase = async () => {
            try {
                // Ora abbiamo i dati di configurazione direttamente nel codice.
                // Non c'√® bisogno del controllo Object.keys(firebaseConfig).length > 0,
                // ma lo usiamo per coerenza con la logica originale se la configurazione fosse vuota per qualche motivo.
                if (firebaseConfig.projectId) { 
                    app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // 1. Autenticazione: usa il token personalizzato o anonima
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        // Accede in modo anonimo (che ora dovrebbe funzionare, visto che √® abilitato)
                        await signInAnonymously(auth);
                    }

                    // 2. Listener per lo stato di autenticazione
                    onAuthStateChanged(auth, (user) => {
                        if (user) {
                            userId = user.uid;
                            document.getElementById('user-info').textContent = `ID Utente: ${userId.substring(0, 8)}...`;
                            loadIcalUrls();
                        } else {
                            // Questo non dovrebbe accadere se signInAnonymously ha successo
                            document.getElementById('user-info').textContent = `Autenticazione Fallita`;
                        }
                    });
                } else {
                     showModal("Errore di Configurazione", "Configurazione Firebase non trovata. L'app non potr√† salvare gli URL.");
                     document.getElementById('user-info').textContent = `Modalit√† Offline (Nessun Salvataggio)`;
                }
                
                // Visualizza il mese corrente all'avvio
                renderMonthTitle();

            } catch (error) {
                console.error("Errore di inizializzazione Firebase:", error);
                showModal("Errore Critico", "Errore nell'inizializzazione di Firebase. Controlla i log della console.");
            }
        };

        // Avvia l'app
        window.onload = initFirebase;
    </script>
</body>
</html>
