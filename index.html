<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Calendario Affitti tipo Airbnb</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap");
    body {
      font-family: "Poppins", sans-serif;
      background: #f3f4f6;
    }

    /* Griglia giorni in alto */
    .day-header-cell {
      min-width: 48px;
      border-right: 1px solid #e5e7eb;
      text-align: center;
      padding: 4px 0;
    }

    /* Riga propriet√† a sinistra */
    .property-cell {
      min-width: 160px;
      max-width: 160px;
      border-bottom: 1px solid #e5e7eb;
      padding: 8px 6px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Griglia giorno nelle righe */
    .row-grid {
      position: relative;
      border-bottom: 1px solid #e5e7eb;
      background-image: linear-gradient(
        to right,
        #e5e7eb 1px,
        transparent 1px
      );
      background-size: 48px 100%;
      min-height: 32px;
    }

    /* Barra prenotazione */
    .reservation-bar {
      position: absolute;
      height: 22px;
      border-radius: 9999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      color: #fff;
      padding: 0 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.18);
      cursor: pointer;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border: 2px solid #fff; /* piccolo bordo bianco per separare le barre */
    }

    .reservation-bar:hover {
      transform: translateY(-1px);
      transition: all 0.1s ease-in-out;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.25);
    }

    /* Tooltip nativo un po' migliore (browser) */
    .reservation-bar[title] {
      white-space: pre-line;
    }

    /* Scrollbar orizzontale pi√π carina */
    .scrollbar-thin {
      scrollbar-width: thin;
    }
    .scrollbar-thin::-webkit-scrollbar {
      height: 7px;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      border-radius: 9999px;
      background: rgba(156, 163, 175, 0.8);
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
  </style>
</head>
<body class="min-h-screen">
  <div class="min-h-screen flex flex-col">
    <!-- NAVBAR -->
    <nav class="bg-white shadow-sm sticky top-0 z-30">
      <div class="max-w-6xl mx-auto px-4 py-3 flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div
            class="h-9 w-9 rounded-2xl bg-indigo-500 flex items-center justify-center text-white font-bold"
          >
            A
          </div>
          <div>
            <div class="font-semibold text-gray-800 text-sm tracking-tight">
              Calendario Affitti
            </div>
            <div class="text-xs text-gray-400 -mt-0.5">
              Vista tipo Airbnb con propriet√† a sinistra e giorni in alto
            </div>
          </div>
        </div>
      </div>
    </nav>

    <!-- CONTENUTO -->
    <main class="flex-1 w-full max-w-6xl mx-auto px-4 py-6 space-y-6">
      <!-- GESTIONE ICAL -->
      <section class="bg-white shadow rounded-2xl p-4 space-y-4">
        <div class="flex justify-between items-center">
          <div>
            <h2 class="text-sm font-semibold text-gray-800">
              Fonti Calendari (iCal)
            </h2>
            <p class="text-xs text-gray-500">
              Ogni URL iCal corrisponde a un appartamento / propriet√†.
            </p>
          </div>
          <span
            id="url-count"
            class="px-2 py-0.5 rounded-full text-[11px] bg-indigo-50 text-indigo-600"
            >0</span
          >
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
          <div class="md:col-span-1">
            <label class="text-xs font-medium text-gray-600"
              >Nome appartamento</label
            >
            <input
              id="ical-name"
              type="text"
              class="w-full rounded-xl border-gray-200 text-sm focus:ring-indigo-500 focus:border-indigo-500"
              placeholder="Es. Vacchereccia"
            />
          </div>
          <div class="md:col-span-2">
            <label class="text-xs font-medium text-gray-600"
              >URL iCal (Airbnb / Booking ...)</label
            >
            <input
              id="ical-url"
              type="text"
              class="w-full rounded-xl border-gray-200 text-sm focus:ring-indigo-500 focus:border-indigo-500"
              placeholder="https://..."
            />
          </div>
        </div>

        <div class="flex flex-wrap gap-3 items-center mt-2">
          <button
            id="add-ical-btn"
            class="inline-flex items-center px-4 py-2 rounded-xl bg-indigo-600 text-white text-sm font-semibold hover:bg-indigo-700"
          >
            + Aggiungi Calendario
          </button>
          <button
            id="sync-btn"
            class="inline-flex items-center px-4 py-2 rounded-xl bg-emerald-500 text-white text-sm font-semibold hover:bg-emerald-600"
          >
            üîÑ Sincronizza Ora
          </button>
          <span
            id="sync-status"
            class="text-xs text-gray-500 ml-1 min-h-[1rem]"
          ></span>
        </div>

        <!-- Lista calendari salvati -->
        <div class="mt-4 border-t border-gray-100 pt-3">
          <div class="flex items-center justify-between mb-2">
            <span class="text-xs font-semibold text-gray-600"
              >Calendari salvati</span
            >
          </div>
          <div id="saved-icals" class="space-y-1 text-xs"></div>
        </div>
      </section>

      <!-- CALENDARIO -->
      <section class="bg-white shadow rounded-2xl p-4 space-y-4">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="text-sm font-semibold text-gray-800">Calendario</h2>
            <p class="text-xs text-gray-500">
              In alto i giorni, a sinistra gli appartamenti. Le barre mostrano
              le notti (check-in incluso, check-out escluso).
            </p>
          </div>
          <div class="flex items-center space-x-2 text-xs">
            <button
              id="prev-btn"
              class="px-2 py-1 rounded-lg border border-gray-200 hover:bg-gray-100"
            >
              ‚Äπ
            </button>
            <button
              id="today-btn"
              class="px-3 py-1 rounded-lg border border-gray-200 hover:bg-gray-100"
            >
              Oggi
            </button>
            <button
              id="next-btn"
              class="px-2 py-1 rounded-lg border border-gray-200 hover:bg-gray-100"
            >
              ‚Ä∫
            </button>
          </div>
        </div>

        <div id="visible-range" class="text-xs text-gray-500"></div>

        <div
          id="calendar-wrapper"
          class="mt-2 overflow-x-auto scrollbar-thin border border-gray-200 rounded-xl bg-gray-50"
        >
          <!-- calendario generato via JS -->
        </div>
      </section>
    </main>
  </div>

  <script>
    // ===============================
    // Configurazione base calendario
    // ===============================

    const VIEW_DAYS = 90; // giorni visibili (3 mesi circa)
    const DAY_WIDTH = 48; // larghezza colonna giorno in px
    const ROW_HEIGHT = 32; // altezza riga per ogni property

    let viewStartDate = startOfDay(new Date()); // oggi come inizio

    // Ogni calendario: {id, name, url, reservations: []}
    let calendars = [];

    // =============== Utilit√† date =================

    function startOfDay(d) {
      const nd = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      nd.setHours(0, 0, 0, 0);
      return nd;
    }

    function addDays(date, days) {
      const d = new Date(date.getTime());
      d.setDate(d.getDate() + days);
      return d;
    }

    function diffInDays(dateA, dateB) {
      const msPerDay = 24 * 60 * 60 * 1000;
      return Math.floor(
        (startOfDay(dateA).getTime() - startOfDay(dateB).getTime()) / msPerDay
      );
    }

    function formatDate(d) {
      return d.toLocaleDateString("it-IT");
    }

    function formatDayLabel(d) {
      const weekday = d
        .toLocaleDateString("it-IT", { weekday: "short" })
        .toUpperCase()
        .replace(".", "");
      const day = d.getDate().toString().padStart(2, "0");
      return { weekday, day };
    }

    // =============== LocalStorage =================

    const STORAGE_KEY = "ical_calendars_v1";

    function loadCalendarsFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return [];
        return JSON.parse(raw);
      } catch (e) {
        console.error("Errore parsing localStorage", e);
        return [];
      }
    }

    function saveCalendarsToStorage() {
      localStorage.setItem(
        STORAGE_KEY,
        JSON.stringify(
          calendars.map((c) => ({
            id: c.id,
            name: c.name,
            url: c.url,
          }))
        )
      );
    }

    // =============== Parsing ICS =================

    function parseIcs(icsText, calendarName) {
      const lines = icsText.split(/\r?\n/);
      const events = [];
      let currentEvent = null;

      function parseDateOnly(val) {
        if (!val) return null;
        val = val.replace("Z", "");
        const datePart = val.split("T")[0];
        if (datePart.length < 8) return null;
        const year = parseInt(datePart.substring(0, 4), 10);
        const month = parseInt(datePart.substring(4, 6), 10) - 1;
        const day = parseInt(datePart.substring(6, 8), 10);
        return new Date(year, month, day);
      }

      for (let line of lines) {
        line = line.trim();
        if (line === "BEGIN:VEVENT") {
          currentEvent = {};
        } else if (line === "END:VEVENT") {
          if (currentEvent && currentEvent.start && currentEvent.checkout) {
            const lastNight = addDays(currentEvent.checkout, -1);
            events.push({
              start: startOfDay(currentEvent.start), // check-in
              end: lastNight, // ultima notte occupata
              checkout: startOfDay(currentEvent.checkout), // giorno in cui l'ospite va via
              summary: currentEvent.summary || "",
              apartmentName: calendarName,
            });
          }
          currentEvent = null;
        } else if (currentEvent) {
          if (line.startsWith("DTSTART")) {
            const val = line.split(":")[1];
            currentEvent.start = parseDateOnly(val);
          } else if (line.startsWith("DTEND")) {
            const val = line.split(":")[1];
            // ICS: DTEND = giorno di check-out (NON soggiornato)
            currentEvent.checkout = parseDateOnly(val);
          } else if (line.startsWith("SUMMARY")) {
            const parts = line.split(":");
            currentEvent.summary = parts.slice(1).join(":") || "";
          }
        }
      }

      return events;
    }

    // =============== Render lista iCal ============

    function renderSavedCalendarsList() {
      const container = document.getElementById("saved-icals");
      container.innerHTML = "";
      document.getElementById("url-count").textContent = calendars.length;

      if (calendars.length === 0) {
        container.innerHTML =
          '<div class="text-xs text-gray-400 italic">Nessun calendario salvato.</div>';
        return;
      }

      calendars.forEach((cal) => {
        const row = document.createElement("div");
        row.className =
          "flex items-center justify-between bg-gray-50 rounded-xl px-3 py-2";

        const left = document.createElement("div");
        left.className = "flex flex-col";
        left.innerHTML = `<span class="text-xs font-semibold text-gray-700">${cal.name}</span>
                          <span class="text-[10px] text-gray-400 truncate max-w-xs">${cal.url}</span>`;

        const btn = document.createElement("button");
        btn.className =
          "text-[11px] text-red-500 hover:text-red-600 ml-2 flex items-center";
        btn.textContent = "Rimuovi";
        btn.onclick = () => {
          calendars = calendars.filter((c) => c.id !== cal.id);
          saveCalendarsToStorage();
          renderSavedCalendarsList();
          renderCalendar(); // svuota eventuali barre
        };

        row.appendChild(left);
        row.appendChild(btn);
        container.appendChild(row);
      });
    }

    // =============== Rendering calendario =========

    function renderCalendar() {
      const wrapper = document.getElementById("calendar-wrapper");
      wrapper.innerHTML = "";

      if (calendars.length === 0) {
        wrapper.innerHTML =
          '<div class="p-6 text-xs text-gray-400 text-center">Aggiungi almeno un URL iCal e sincronizza per vedere il calendario.</div>';
        document.getElementById("visible-range").textContent = "";
        return;
      }

      const startDate = viewStartDate;
      const endDate = addDays(startDate, VIEW_DAYS - 1);

      document.getElementById(
        "visible-range"
      ).textContent = `Periodo visualizzato: ${formatDate(
        startDate
      )} - ${formatDate(endDate)} (${VIEW_DAYS} giorni)`;

      const msPerDay = 24 * 60 * 60 * 1000;
      const gridWidth = VIEW_DAYS * DAY_WIDTH;

      // Header: giorni
      const headerRow = document.createElement("div");
      headerRow.className =
        "flex sticky top-0 bg-gray-50 border-b border-gray-200 z-10";

      // prima cella vuota per la colonna "Propriet√†"
      const empty = document.createElement("div");
      empty.className =
        "property-cell bg-gray-50 font-semibold text-[11px] uppercase tracking-wide";
      empty.textContent = "Propriet√†";
      headerRow.appendChild(empty);

      // celle giorno
      const daysContainer = document.createElement("div");
      daysContainer.className = "flex";
      daysContainer.style.width = gridWidth + "px";

      for (let i = 0; i < VIEW_DAYS; i++) {
        const d = addDays(startDate, i);
        const { weekday, day } = formatDayLabel(d);
        const cell = document.createElement("div");
        cell.className = "day-header-cell";
        cell.innerHTML = `<div class="text-[10px] text-gray-500">${weekday}</div>
                          <div class="text-[12px] font-semibold text-gray-800">${day}</div>`;
        daysContainer.appendChild(cell);
      }

      headerRow.appendChild(daysContainer);
      wrapper.appendChild(headerRow);

      // Corpo: una riga per ogni appartamento
      calendars.forEach((cal, idx) => {
        const row = document.createElement("div");
        row.className = "flex";

        const propCell = document.createElement("div");
        propCell.className =
          "property-cell bg-white border-r border-gray-200 text-[12px]";
        propCell.textContent = cal.name || `Calendario ${idx + 1}`;
        row.appendChild(propCell);

        const gridCell = document.createElement("div");
        gridCell.className = "row-grid";
        gridCell.style.width = gridWidth + "px";
        gridCell.style.height = ROW_HEIGHT + "px";

        // Filtra le prenotazioni di questo calendario
        const reservations = (cal.reservations || []).slice().sort((a, b) => {
          return a.start.getTime() - b.start.getTime();
        });

        const BAR_GAP = 8;

        reservations.forEach((res) => {
          const startTime = res.start.getTime();
          const lastNightTime = res.end.getTime();

          // se completamente fuori dalla finestra, salta
          if (lastNightTime < startDate.getTime()) return;
          if (startTime > endDate.getTime()) return;

          const clampedStart = new Date(
            Math.max(startTime, startDate.getTime())
          );
          const clampedEnd = new Date(
            Math.min(lastNightTime, endDate.getTime())
          );

          const startIndex = Math.floor(
            (startOfDay(clampedStart).getTime() -
              startOfDay(startDate).getTime()) /
              msPerDay
          );
          const endIndex = Math.floor(
            (startOfDay(clampedEnd).getTime() -
              startOfDay(startDate).getTime()) /
              msPerDay
          );
          const durationDays = Math.max(1, endIndex - startIndex + 1);

          const bar = document.createElement("div");
          bar.className = "reservation-bar";
          // colori alternati
          const colors = ["#ef4444", "#16a34a", "#0ea5e9", "#f97316", "#a855f7"];
          bar.style.backgroundColor =
            colors[idx % colors.length]; /* per riga diversa */

          const totalWidthPx = durationDays * DAY_WIDTH - BAR_GAP;
          const offsetLeftPx = startIndex * DAY_WIDTH + BAR_GAP / 2;

          bar.style.left = offsetLeftPx + "px";
          // centrata verticalmente
          bar.style.top = (ROW_HEIGHT - 22) / 2 + "px";
          bar.style.width = totalWidthPx + "px";

          const tooltip =
            `Appartamento: ${res.apartmentName}\n` +
            `Check-in: ${formatDate(res.start)}\n` +
            `Check-out: ${formatDate(res.checkout)}\n` +
            `Riepilogo: ${res.summary || ""}`;
          bar.title = tooltip;
          bar.textContent = res.summary || res.apartmentName || "Prenotazione";

          gridCell.appendChild(bar);
        });

        row.appendChild(gridCell);
        wrapper.appendChild(row);
      });
    }

    // =============== Sincronizzazione ============

    async function syncCalendars() {
      if (calendars.length === 0) {
        document.getElementById("sync-status").textContent =
          "Aggiungi almeno un URL iCal.";
        return;
      }

      document.getElementById("sync-status").textContent =
        "Sincronizzazione in corso...";

      for (const cal of calendars) {
        cal.reservations = [];
      }

      for (const cal of calendars) {
        try {
          const resp = await fetch(cal.url);
          if (!resp.ok) {
            console.error("Errore fetch", cal.url, resp.status);
            continue;
          }
          const text = await resp.text();
          cal.reservations = parseIcs(text, cal.name);
        } catch (e) {
          console.error("Errore nel fetch/parsing ICS", cal.url, e);
        }
      }

      document.getElementById("sync-status").textContent =
        "Sincronizzazione completata.";
      renderCalendar();
    }

    // =============== Event handlers ==============

    document.getElementById("add-ical-btn").addEventListener("click", () => {
      const nameInput = document.getElementById("ical-name");
      const urlInput = document.getElementById("ical-url");
      const name = nameInput.value.trim();
      const url = urlInput.value.trim();

      if (!name || !url) {
        alert("Inserisci sia il nome sia l'URL iCal");
        return;
      }

      const id = Date.now().toString();
      calendars.push({ id, name, url, reservations: [] });
      saveCalendarsToStorage();
      renderSavedCalendarsList();

      nameInput.value = "";
      urlInput.value = "";
    });

    document.getElementById("sync-btn").addEventListener("click", () => {
      syncCalendars();
    });

    document.getElementById("prev-btn").addEventListener("click", () => {
      viewStartDate = addDays(viewStartDate, -30);
      renderCalendar();
    });

    document.getElementById("next-btn").addEventListener("click", () => {
      viewStartDate = addDays(viewStartDate, 30);
      renderCalendar();
    });

    document.getElementById("today-btn").addEventListener("click", () => {
      viewStartDate = startOfDay(new Date());
      renderCalendar();
    });

    // =============== Init ========================

    function init() {
      const stored = loadCalendarsFromStorage();
      calendars = stored.map((c) => ({
        id: c.id,
        name: c.name,
        url: c.url,
        reservations: [],
      }));

      renderSavedCalendarsList();
      renderCalendar();
    }

    init();
  </script>
</body>
</html>































































































































