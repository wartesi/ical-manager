<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestore Calendari iCal Airbnb</title>
    <!-- Caricamento di Tailwind CSS per lo styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Utilizzo del font Inter -->
    <style>
       @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* STILI PER CALENDARIO ORIZZONTALE */
        #calendar-container {
            overflow-x: auto; /* Permette lo scroll laterale */
            white-space: nowrap; /* I giorni restano in riga */
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding-bottom: 8px;
            background-color: #f9fafb;
        }

        /* Colonna del singolo giorno */
        .day-column {
            display: inline-block;
            width: 140px; /* Larghezza fissa */
            min-height: 140px;
            border-right: 1px solid #e5e7eb;
            padding: 10px;
            vertical-align: top;
            background-color: white;
            box-sizing: border-box; 
        }
        
        /* Prenotazione */
        .reservation {
            font-size: 11px;
            padding: 4px 6px;
            margin-bottom: 4px;
            border-radius: 6px;
            white-space: normal; /* Testo a capo */
            overflow: hidden;
            cursor: help;
            border: 1px solid rgba(0,0,0,0.05);
        }
        
        .day-label {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: 4px;
            text-align: center;
            text-transform: uppercase;
            color: #6b7280;
        }
        
        .day-number {
            font-size: 20px;
            font-weight: 800;
            text-align: center;
            margin-bottom: 8px;
            color: #1f2937;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <div id="app" class="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
        <header class="bg-white shadow-lg rounded-xl p-4 mb-6 flex flex-col sm:flex-row justify-between items-center">
            <div>
                <h1 class="text-3xl font-bold text-indigo-700">üóìÔ∏è Calendario Unificato Affitti Brevi</h1>
                <p class="text-sm text-gray-500 mt-1">Gestione Affitti Brevi (Orizzontale)</p>
            </div>
            <div class="mt-4 sm:mt-0 flex items-center gap-4">
                <div class="bg-indigo-50 px-4 py-2 rounded-lg">
                    <p id="user-info" class="text-sm text-indigo-800 font-medium">Inizializzazione...</p>
                </div>
                <!-- Pulsanti per la nuova autenticazione -->
                <button onclick="window.toggleAuthModal()" id="auth-button" class="bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 shadow-md transition-all duration-200" style="display:none;">
                    Accedi / Registrati
                </button>
                <button onclick="window.handleSignOut()" id="logout-button" class="bg-gray-300 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-400 shadow-md transition-all duration-200" style="display:none;">
                    Esci
                </button>
            </div>
        </header>

        <!-- Sezione Inserimento URL iCal -->
        <section class="bg-white shadow-lg rounded-xl p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Aggiungi Calendario iCal</h2>
            <div class="flex flex-col sm:flex-row gap-4 mb-4">
                <input type="text" id="ical-name" placeholder="Nome Appartamento (es. Monolocale Centro)"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <input type="url" id="ical-url" placeholder="URL iCal (inizia con webcal:// o https://)"
                       class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                <button onclick="saveIcalUrl()"
                        class="bg-indigo-600 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-700 transition duration-150 shadow-md whitespace-nowrap">
                    Salva URL
                </button>
            </div>
            <p class="text-xs text-red-600" id="error-message" style="display: none;"></p>
        </section>

        <!-- Sezione URL Salvati e Sincronizzazione -->
        <section class="bg-white shadow-lg rounded-xl p-6 mb-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">I Miei Calendari Salvati (<span id="url-count">0</span>)</h2>
            <div id="ical-list" class="space-y-3">
                <!-- URL iCal salvati saranno iniettati qui -->
                <p class="text-sm text-gray-500" id="loading-urls">Caricamento URL salvati...</p>
            </div>
            <button onclick="loadCalendar()" id="sync-button"
                    class="mt-6 w-full bg-green-600 text-white font-semibold py-3 rounded-lg hover:bg-green-700 transition duration-150 shadow-lg">
                Sincronizza e Visualizza Calendario
            </button>
        </section>

       <!-- Sezione Visualizzazione Calendario Orizzontale -->
        <section class="bg-white shadow-lg rounded-xl p-6">
            <h2 class="text-xl font-semibold text-gray-800 mb-4">Visualizzazione Prenotazioni (Orizzontale)</h2>

            <!-- Navigazione Mese/Giorni -->
            <div class="flex justify-between items-center mb-4">
                <button onclick="changePeriod(-1)" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <span id="current-period" class="text-xl font-bold text-gray-800"></span>
                <button onclick="changePeriod(1)" class="p-2 rounded-full bg-gray-100 hover:bg-gray-200">
                    <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>

            <!-- Contenitore del Calendario Orizzontale Scrollabile -->
            <div id="calendar-container">
                <div id="calendar-grid">
                    <!-- Le colonne dei giorni saranno generate qui -->
                    <p class="col-span-7 text-center py-8 text-gray-500" id="calendar-placeholder">Premi "Sincronizza" per caricare le prenotazioni.</p>
                </div>
            </div>
        </section>

         <!-- Modal di Avviso (Personalizzato) -->
        <div id="modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center p-4 z-50">
            <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full">
                <h3 class="text-lg font-bold text-red-600 mb-3" id="modal-title"></h3>
                <p class="text-sm text-gray-700 mb-4" id="modal-content"></p>
                <button onclick="closeModal()" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700">Chiudi</button>
            </div>
        </div>
    </div>

    <!-- Firebase Imports e Logica -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, EmailAuthProvider, linkWithCredential } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, onSnapshot, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
// --- VARIABILI GLOBALI ---
        let app, db, auth, userId = null;
        let icalUrls = [];
        let allReservations = [];
        let isAnon = true; // Nuovo: Traccia se l'utente √® anonimo
        
        // Impostazioni Calendario Orizzontale
        let currentStartDate = new Date();
        currentStartDate.setHours(0, 0, 0, 0); 
        const VIEW_DAYS = 45; 
        
        const ICAL_COLLECTION = "ical_urls";
        const ICAL_PROXY_URL = "https://ical-proxy-worker.glitch.me/"; // Proxy CORS (lasciamo Glitch come ultima versione)
        
        // --- CONFIGURAZIONE FIREBASE ---
        const appId = 'calendario-affitti-brevi'; 
        const firebaseConfig = {
            apiKey: "AIzaSyA9eZ39CpSSCMF6bORHqOAD39BKqHhLCuk",
            authDomain: "calendario-affitti-brevi.firebaseapp.com",
            projectId: "calendario-affitti-brevi",
            storageBucket: "calendario-affitti-brevi.firebasestorage.app",
            messagingSenderId: "338062221076",
            appId: "1:338062221076:web:02d734c5a712a26a38ac01",
            measurementId: "G-2EJGFF5RPQ"
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initialAuthToken : null; 
        
        // Elementi DOM aggiornati per i nuovi pulsanti e modal
        const icalListEl = document.getElementById('ical-list');
        const syncButton = document.getElementById('sync-button');
        const authButton = document.getElementById('auth-button'); 
        const logoutButton = document.getElementById('logout-button'); 
        const userInfoEl = document.getElementById('user-info');
        // I seguenti elementi sono per il nuovo modal, assicurati che il modal sia stato incollato
        const authModalEl = document.getElementById('auth-modal'); 
        const authStatusEl = document.getElementById('auth-status-message'); 
        const loginFormEl = document.getElementById('login-form');
        const registerFormEl = document.getElementById('register-form');
        
// --- FUNZIONI DI UTILITY ---
        window.showModal = (title, message) => {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-content').textContent = message;
            document.getElementById('modal').classList.remove('hidden');
            document.getElementById('modal').classList.add('flex');
        };
        window.closeModal = () => {
            document.getElementById('modal').classList.add('hidden');
            document.getElementById('modal').classList.remove('flex');
        };

        // --- FUNZIONI AUTH MODAL ---
        window.toggleAuthModal = () => {
            if (authModalEl.classList.contains('hidden')) {
                authModalEl.classList.remove('hidden');
                authModalEl.classList.add('flex');
                authStatusEl.textContent = ''; // Resetta lo stato del messaggio
                document.getElementById('auth-email').value = '';
                document.getElementById('auth-password').value = '';
            } else {
                authModalEl.classList.add('hidden');
                authModalEl.classList.remove('flex');
            }
        };

        window.toggleAuthForm = (showLogin) => {
            if (showLogin) {
                loginFormEl.classList.remove('hidden');
                registerFormEl.classList.add('hidden');
            } else {
                loginFormEl.classList.add('hidden');
                registerFormEl.classList.remove('hidden');
            }
            authStatusEl.textContent = '';
        };

        // --- LOGICA DI AUTENTICAZIONE EMAIL/PASSWORD ---

        window.handleSignIn = async () => {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            authStatusEl.textContent = 'Accesso in corso...';

            try {
                await signInWithEmailAndPassword(auth, email, password);
                authStatusEl.textContent = 'Accesso riuscito!';
                window.toggleAuthModal();
            } catch (error) {
                authStatusEl.textContent = `Errore accesso: ${error.message}`;
                console.error("Errore di accesso:", error);
            }
        };

        window.handleRegister = async () => {
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            authStatusEl.textContent = 'Registrazione in corso...';
            
            try {
                // 1. Crea l'utente Email/Password
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // 2. Collega l'utente anonimo esistente a questo nuovo account
                if (auth.currentUser && auth.currentUser.isAnonymous) {
                    const anonUser = auth.currentUser;
                    const credential = EmailAuthProvider.credential(email, password);
                    
                    // Linka l'account anonimo al nuovo account permanente
                    await linkWithCredential(anonUser, credential);
                    
                    // La funzione onAuthStateChanged si occuper√† di ricaricare i dati e aggiornare l'UI
                    authStatusEl.textContent = 'Registrazione e migrazione dati riuscita!';
                }
                
                window.toggleAuthModal();

            } catch (error) {
                authStatusEl.textContent = `Errore registrazione: ${error.message}`;
                console.error("Errore di registrazione:", error);
            }
        };
        
        window.handleSignOut = async () => {
            try {
                await signOut(auth);
                // Dopo il logout, onAuthStateChanged gestir√† il re-login anonimo
            } catch (error) {
                console.error("Errore durante il logout:", error);
            }
        };
        http://googleusercontent.com/immersive_entry_chip/1
        // --- PARSING ICAL ---
        const icalToDate = (icalDate) => {
            const y = icalDate.substring(0, 4);
            const m = icalDate.substring(4, 6);
            const d = icalDate.substring(6, 8);
            const date = new Date(y, m - 1, d);
            date.setHours(0, 0, 0, 0);
            return date;
        };
        
        const parseIcalContent = (icsContent, name) => {
            const events = [];
            const eventRegex = /BEGIN:VEVENT([\s\S]*?)END:VEVENT/g;
            let match;
            while ((match = eventRegex.exec(icsContent)) !== null) {
                const txt = match[1];
                const start = txt.match(/DTSTART(?:[^:]*?):(\d{8})/i);
                const end = txt.match(/DTEND(?:[^:]*?):(\d{8})/i);
                const summary = txt.match(/SUMMARY:(.*)/i);

                if (start && end && summary) {
                    const sDate = icalToDate(start[1]);
                    const eDate = icalToDate(end[1]);
                    // Fine reale = giorno prima del checkout per visualizzazione
                    const actualEnd = new Date(eDate);
                    actualEnd.setDate(actualEnd.getDate() - 1);
                    actualEnd.setHours(0, 0, 0, 0);

                    events.push({
                        id: `${name}-${sDate.getTime()}`,
                        apartmentName: name,
                        start: sDate,
                        end: actualEnd,
                        summary: summary[1].trim(),
                    });
                }
            }
            return events;
        };

        // --- FIRESTORE ---
        const getPath = () => `/artifacts/${appId}/users/${userId}/${ICAL_COLLECTION}`;

        const loadIcalUrls = () => {
            if (!db || !userId) return;
            onSnapshot(query(collection(db, getPath())), (snap) => {
                icalUrls = [];
                icalListEl.innerHTML = ''; 
                snap.forEach((doc) => icalUrls.push({ id: doc.id, ...doc.data() }));
                
                if (icalUrls.length === 0) {
                    icalListEl.innerHTML = '<p class="text-sm text-gray-500">Nessun calendario salvato.</p>';
                } else {
                    icalUrls.forEach(ical => {
                        const div = document.createElement('div');
                        div.className = 'flex justify-between items-center p-3 bg-gray-50 rounded border';
                        div.innerHTML = `
                            <div class="truncate pr-2">
                                <div class="font-bold text-sm">${ical.name}</div>
                                <div class="text-xs text-gray-400 truncate">${ical.url}</div>
                            </div>
                            <button onclick="deleteIcalUrl('${ical.id}')" class="text-red-500">üóëÔ∏è</button>`;
                        icalListEl.appendChild(div);
                    });
                }
                document.getElementById('url-count').textContent = icalUrls.length;
                document.getElementById('loading-urls').style.display = 'none';
            });
        };

        window.saveIcalUrl = async () => {
            if (!userId) return showModal("Errore", "Non autenticato");
            const name = document.getElementById('ical-name').value.trim();
            let url = document.getElementById('ical-url').value.trim();
            if (!name || !url) return showModal("Errore", "Dati mancanti");
            
            if (url.startsWith('webcal://')) url = 'https://' + url.substring(9);
            
            try {
                await setDoc(doc(collection(db, getPath())), { name, url });
                document.getElementById('ical-name').value = '';
                document.getElementById('ical-url').value = '';
                showModal("Fatto", "Salvato!");
            } catch (e) { console.error(e); }
        };

        window.deleteIcalUrl = async (id) => {
            if (userId) await deleteDoc(doc(db, getPath(), id));
        };

        // --- LOGICA CALENDARIO ---
       window.loadCalendar = async () => {
            if (!userId) return;
            syncButton.textContent = "Caricamento...";
            syncButton.disabled = true;
            allReservations = [];
            
            for (const ical of icalUrls) {
                try {
                    let fetchUrl = ical.url;
                    
                    // --- LOGICA PROXY CORRETTA ---
                    // Controlla se l'URL √® https, se √® di Airbnb e se non ha gi√† il proxy.
                    // Se tutte le condizioni sono vere, anteponi il proxy.
                    if (fetchUrl.startsWith('https://') && fetchUrl.includes('airbnb') && !fetchUrl.includes(ICAL_PROXY_URL)) {
                        fetchUrl = ICAL_PROXY_URL + fetchUrl;
                    }
                    // -----------------------------

                    const res = await fetch(fetchUrl);
                    if (!res.ok) throw new Error("Errore rete");
                    const txt = await res.text();
                    allReservations.push(...parseIcalContent(txt, ical.name));
                } catch (e) { 
                    console.error(`Errore caricamento ${ical.name}:`, e); 
                }
            }
            
            syncButton.textContent = "Sincronizza Ora";
            syncButton.disabled = false;
            
            // Resetta sempre su oggi dopo il caricamento e aggiorna la vista
            currentStartDate = new Date();
            currentStartDate.setHours(0, 0, 0, 0);
            renderCalendar();
            
            if (allReservations.length > 0) {
                showModal("Successo", `Caricate ${allReservations.length} prenotazioni.`);
            } else {
                // Mostra un avviso solo se c'erano calendari da caricare ma nessuna prenotazione trovata (o errore)
                if (icalUrls.length > 0) {
                    showModal("Attenzione", "Nessuna prenotazione trovata o errore di caricamento. Controlla la console per i dettagli.");
                }
            }
        };

        window.changePeriod = (delta) => {
            currentStartDate.setDate(currentStartDate.getDate() + (delta * VIEW_DAYS));
            renderCalendar();
        };

        const renderCalendar = () => {
            const gridEl = document.getElementById('calendar-grid');
            gridEl.innerHTML = '';
            gridEl.style.display = 'flex'; // Importante per orizzontale
            
            // Titolo periodo
            const endPeriod = new Date(currentStartDate);
            endPeriod.setDate(endPeriod.getDate() + VIEW_DAYS - 1);
            document.getElementById('current-period').textContent = 
                `${currentStartDate.toLocaleDateString('it-IT')} - ${endPeriod.toLocaleDateString('it-IT')}`;

            const today = new Date(); 
            today.setHours(0,0,0,0);

            // Genera giorni
            for (let i = 0; i < VIEW_DAYS; i++) {
                const date = new Date(currentStartDate);
                date.setDate(date.getDate() + i);
                
                const isToday = date.getTime() === today.getTime();
                const dayName = date.toLocaleDateString('it-IT', { weekday: 'short' });
                
                const col = document.createElement('div');
                col.className = `day-column ${isToday ? 'bg-blue-50 border-t-4 border-blue-500' : ''}`;
                
                col.innerHTML = `
                    <div class="day-label">${dayName}</div>
                    <div class="day-number">${date.getDate()}</div>
                    <hr class="my-2">
                `;

                // Cerca prenotazioni per questo giorno
                allReservations.forEach(res => {
                    if (date >= res.start && date <= res.end) {
                        const div = document.createElement('div');
                        // Colori casuali basati sul nome
                        const colors = ['bg-red-100 text-red-800', 'bg-green-100 text-green-800', 'bg-blue-100 text-blue-800', 'bg-yellow-100 text-yellow-800', 'bg-purple-100 text-purple-800'];
                        const colorClass = colors[res.apartmentName.length % colors.length];
                        
                        div.className = `reservation ${colorClass}`;
                        div.textContent = res.apartmentName;
                        div.title = res.summary;
                        col.appendChild(div);
                    }
                });
                
                gridEl.appendChild(col);
            }
        };

// --- INIT ---
        
        const updateUI = (user) => {
            if (user) {
                userId = user.uid;
                isAnon = user.isAnonymous;

                userInfoEl.textContent = isAnon ? 
                    `Accesso Anonimo (${userId.substring(0, 5)}...)` : 
                    `Connesso: ${user.email}`;
                
                authButton.style.display = isAnon ? 'block' : 'none';
                logoutButton.style.display = isAnon ? 'none' : 'block';

                loadIcalUrls();
            } else {
                // Nessun utente √® autenticato, tenta l'accesso anonimo se non √® gi√† attivo
                authButton.style.display = 'block';
                logoutButton.style.display = 'none';
                userInfoEl.textContent = 'Disconnesso. Clicca per accedere.';
            }
            // Assicura che la vista calendario venga renderizzata anche senza dati
            renderCalendar(); 
        };

        const initFirebase = async () => {
            if(firebaseConfig.projectId) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Imposta il listener di stato per la gestione UI
                onAuthStateChanged(auth, updateUI); 

                try {
                    // 1. Tenta l'accesso con token custom (se siamo nella piattaforma canvas)
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    }
                    
                    // 2. Se nessun utente √® connesso (o solo il custom token ha fallito), forza l'accesso anonimo
                    if (!auth.currentUser) {
                        await signInAnonymously(auth);
                    }
                    
                } catch (error) {
                    console.error("Errore nel processo di accesso iniziale:", error);
                    userInfoEl.textContent = 'Errore Autenticazione';
                }
            } else {
                userInfoEl.textContent = 'Errore Configurazione Firebase';
                showModal("Errore Critico", "Configurazione Firebase non trovata.");
            }
            // Non chiamare renderCalendar qui, √® gestito da updateUI
        };
        
        window.onload = initFirebase;
    </script>
</body>
</html>













